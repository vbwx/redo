#!/bin/bash

function recurse {
	declare -x INDEX=0 COUNT=$#
	[ $DEPTH -eq 0 ] && RCOUNT=$#

	for d in "$@"; do
		[ $DEPTH -eq 0 ] && ((RINDEX++))
		((INDEX++))
		[[ -d $d && -x $d && -r $d ]] || continue
		cd "$d"
		((DEPTH++))
		((RUNS++))

		if [ ${#indir[*]} -gt 0 ]; then
			dirs=(${indir[*]})
		else
			dirs=(*/)
		fi
		if [ ${#exdir[*]} -gt 0 ]; then
			for ex in ${exdir[*]}; do
				i=0
				count=${#dirs[*]}
				while [ $i -lt $count ]; do
					if [[ ${dirs[$i]%/} == ${ex%/} ]]; then
						unset 'dirs[i]'
						break
					fi
					((i++))
				done
			done
		fi

		DIR=${d//\//}
		CWD=${PWD#*$ROOT/}
		printf "$script" | $program ${ARGS[*]}
		recurse "${dirs[@]}"
		((DEPTH--))
		cd ..
	done
}

shopt -s nullglob

if [[ $1 == "--help" ]]; then
	cat <<-'EOF'
		usage: redo [-exclude_glob ...] [+include_glob ...] [dir ...] < script
		variables: $DIR, $CWD, $COUNT, $INDEX, $DEPTH, $RUNS
		           $ROOT, $ARGS, $RCOUNT, $RINDEX
	EOF
	exit
fi
if [[ $1 == "--version" ]]; then
	echo "redo 1.0"
	echo "Copyright 2017 Bernhard Waldbrunner"
	exit
fi

indir=()
exdir=()
dirs=()
export DIR CWD RCOUNT ARGS RINDEX=0 DEPTH=0 RUNS=0 ROOT="$PWD"

for arg in "$@"; do
	if [[ ${arg:0:1} == '-' ]]; then
		exdir[${#exdir[*]}]="${arg:1}"
	elif [[ ${arg:0:1} == '+' ]]; then
		indir[${#indir[*]}]="${arg:1}"
	else
		dirs[${#dirs[*]}]="$arg"
	fi
done

[ ${#dirs[*]} -eq 0 ] && dirs=(*/)

_IFS=$IFS
IFS=$'\n'
read program
script=$(</dev/stdin)
if [[ ${program:0:2} == '#!' ]]; then
	IFS=$_IFS
	program=(${program:2})
	ARGS=(${program[@]:1})
	program=${program[@]:0:1}
	IFS=$'\n'
else
	script="${program}\n${script}"
	program=$SHELL
	args=
fi

recurse "${dirs[@]}"
