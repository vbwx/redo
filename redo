#!/bin/bash

set -eu
shopt -s nullglob
IFS=$'\t\n'

function recurse {
	declare -x INDEX=0 COUNT=$#
	[ $DEPTH -eq 0 ] && RCOUNT=$#

	for d in "$@"; do
		[ $DEPTH -eq 0 ] && ((RINDEX++))
		((INDEX++))
		d="${d%/}"
		if ! [[ -d $d ]]; then
			echo "redo: ${CWD:+$CWD/}$d: No such directory" >&2
			continue
		fi
		if ! [[ -x $d && -r $d ]]; then
			echo "redo: ${CWD:+$CWD/}$d: Permission denied" >&2
			continue
		fi
		[[ $nocd ]] || cd "$d"
		((DEPTH++))
		((RUNS++))

		if [ ${#indir[@]} -gt 0 ]; then
			if [[ $nocd ]]; then
				dirs=(${indir[@]/#/$d/})
			else
				dirs=(${indir[@]})
			fi
		else
			if [[ $nocd ]]; then
				dirs=("$d"/*/)
			else
				dirs=(*/)
			fi
		fi
		if [ ${#exdir[@]} -gt 0 ]; then
			if [[ $nocd ]]; then
				exclude=(${exdir[@]/#/$d/})
			else
				exclude=(${exdir[@]})
			fi
			count=${#dirs[@]}
			for e in ${exclude[@]}; do
				i=0
				while [ $i -lt $count ]; do
					if [[ ${dirs[i]%/} == ${e%/} ]]; then
						unset 'dirs[i]'
						break
					fi
					((i++))
				done
			done
		fi

		DIR="$d"
		[[ $nocd ]] || CWD="${PWD#*$ROOT/}"
		"$script"
		(( ${#dirs[@]} )) && recurse "${dirs[@]}"
		((DEPTH--))
		[[ $nocd ]] || cd ..
	done
}

if [[ ${1-} == "--help" ]]; then
	cat <<-'EOF'
		usage: redo [.] [+include_glob ...] [-exclude_glob ...] [dir ...] < script
		variables: $DIR, $CWD, $COUNT, $INDEX, $DEPTH, $RUNS
		           $ROOT, $RCOUNT, $RINDEX
	EOF
	exit
fi
if [[ ${1-} == "--version" ]]; then
	echo "redo 1.1"
	echo "Copyright 2017-2019 Bernhard Waldbrunner"
	exit
fi

indir=()
exdir=()
dirs=()
nocd=
export DIR CWD RCOUNT RINDEX=0 DEPTH=0 RUNS=0 ROOT="$PWD"

for arg in "$@"; do
	if [[ ${arg:0:1} == '-' ]]; then
		exdir[${#exdir[@]}]="${arg:1}"
	elif [[ ${arg:0:1} == '+' ]]; then
		indir[${#indir[@]}]="${arg:1}"
	elif [[ $arg == '.' ]]; then
		nocd=1
		CWD="."
	else
		dirs[${#dirs[@]}]="$arg"
	fi
done

[ ${#dirs[@]} -eq 0 ] && dirs=(*/)

script=$(mktemp -t redo)
cat > "$script"
chmod +x "$script"
recurse "${dirs[@]}"
rm -f "$script"
